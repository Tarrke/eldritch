<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Mush Chtulhu</title>
        <style>
            #zone_chat strong {
                color: white;
                background-color: black;
                padding: 2px;
            }
            .container {height: 60%; width: 1500px; font-size: 0; background: purple}
            .left, .middle, .right {display: inline-block; *display: inline; zoom: 1; vertical-align: top; font-size: 12px;}
            .left {width: 240px; background: blue;}
            .middle {width: 490px; background: green;}
            .right {background: yellow; overflow-y:auto; height: 400px; width: 480px;}
            #head {text-align:center;}
        </style>
        <script src="//cdn.jsdelivr.net/phaser/2.5.0/phaser.min.js"></script>
    </head>
 
    <body>
        <div id="head">
            <h1>Cthulhush \!/</h1>
            <p>TODO: insert menu horizontal</p>
        </div>

        <div id="main" class="container">
            <div id="personnage" class="left">
                <img src="images/janice_kent.jpg"/>
            </div>
            <div id="jeu" class="middle">
                <div id='gameDiv'></div>
<!--
                <img src="images/janice_kent.jpg" style="width: 100%;"/>
-->
            </div>
            <div id="chat" class="right">
                <form action="/" method="post" id="form_client">
                    <input type="text" name="message" id="message" placeholder="Votre message..." size=45 autofocus autocomplete="off" />
                    <input type="submit" id="send_message" value="Envoyer" style="visibility: hidden;"/>
                </form>

                <section id="zone_clients">
			<p>Connectés :</p>
                </section>

                <section id="zone_chat">
                </section>
            </div>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io.connect('http://127.0.0.1:4433');
            var pseudo = prompt("Quel est votre pseudo ?");
            socket.emit('new_client', pseudo);
            console.log('New client: ' + pseudo);
            document.title = pseudo + ' - ' + document.title;

            // Nouveau message
            socket.on('message', function(data){
                insertMessage(data.pseudo, data.message)
            })

            // Nouveau client
            socket.on('new_client', function(pseudo) {
                console.log("event new_client");
                newPlayer(pseudo);
                console.log("end event new_client");
            });

            // Deconnexion
            socket.on('client_leave', function( pseudo ) {
                lostPlayer(pseudo);
            });

            socket.on('already_used', function() {
                console.log('pseudo already in use !');
                pseudo = prompt('Pseudo déjà utilisé');
                socket.emit('new_client', pseudo);
            });

            // Get clients list
            socket.on('client_list', function( clients ) {
                console.log('Clients: ' + clients);
                if( document.getElementById('cList') !== null ) {
                    document.getElementById('zone_clients').removeChild(document.getElementById('cList'));
                }
                var p = document.createElement("p");
                p.setAttribute("id", "cList");
                p.append(clients[0]);
                console.log("getting to for");
                cLen = clients.length;
                console.log(cLen);
                for( i = 1; i < cLen; ++i) {
                    console.log("inside for");
                    p.append(', ' + clients[i]);
                }
                document.getElementById('zone_clients').append(p);
            });

            // Envoie du formulaire
            document.getElementById('form_client').onsubmit = function(event) {
                event.preventDefault();
                console.log('Call submit form');
                var message = document.getElementById('message').value;
                socket.emit('message', message);
                insertMessage(pseudo, message);
                document.getElementById('message').value = '' ;
                document.getElementById('message').focus();
                console.log('Return from submit form');
                return false; // Permet de bloquer l'envoi classique...
            }


            // Ajoute un message à la zone de texte :
            function insertMessage(pseudo, message) {
                console.log('Call insertMessage');
                var p = document.createElement("p");
                var s = document.createElement("strong");
                s.append(pseudo);
                p.append(s);
                p.append(decodeHTML(message));
                document.getElementById('zone_chat').prepend(p);
                console.log('End insertMessage');
            }
            
            // Ajoute le message de nouveau venu :
            function newPlayer(pseudo) {
                console.log('Call newPlayer');
                var p = document.createElement("p");
                var s = document.createElement("em");
                s.append(pseudo + ' a rejoint la discussion.');
                p.append(s);
                document.getElementById('zone_chat').prepend(p);
                console.log('End newPlayer');
            }

            // Ajoute le message de départ :
            function lostPlayer(pseudo) {
                console.log('Call newPlayer');
                var p = document.createElement("p");
                var s = document.createElement("em");
                s.append(pseudo + ' a quitté la discussion.');
                p.append(s);
                document.getElementById('zone_chat').prepend(p);
                console.log('End newPlayer');
            }

            function decodeHTML(html) {
                var txt = document.createElement("textarea");
                txt.innerHTML = html;
                return txt.value;
            }

        </script>
        <script type="text/javascript">
            
            window.onload = function() {
                var gameScene;
                var tileWidth = 24;
                var floorSprite;
                var wallSprite;
                var wallHeight = 0;
                var borderOffset = new Phaser.Point(250,50); //to centralize the isometric level display
                
                var levelData = 
                    [[1,1,1,1,1,1],
                     [1,0,0,0,0,1],
                     [1,0,0,0,0,1],
                     [1,0,0,0,0,1],
                     [1,0,0,0,0,1],
                     [1,1,1,1,1,1]];

                function createLevel() {
                    var tileType = 0;
                    //~ for( var i = 0; i < levelData.lenght; i++ ) {
                        //~ for( var j = 0; j < levelData[0].lenght; j++) {
                            //~ tileType = levelData[i][j];
                            //~ placeTile(tileType, i, j);
                        //~ }
                    //~ }
                    
                    //~ heroMapTile = new Phaser.Point(0,0);
                    //~ addHero();
                    //~ ...
                    
                    renderScene();
                }
                
                function renderScene() {
                    console.log("calling renderScene()");
                    gameScene.clear();
                    var tileType = 0;
                    for( var i = 0; i < levelData.length; ++i ) {
                        for( var j = 0; j < levelData[0].length; ++j ) {
                            tileType = levelData[i][j];
                            drawTileIso(tileType, i,j);
                        }
                    }
                }
                
                function drawTileIso(tileType, i, j) {
                    var isoPt  = new Phaser.Point();
                    var cartPt = new Phaser.Point();
                    cartPt.x = j*tileWidth;
                    cartPt.y = i*tileWidth;
                    isoPt = cartesianToIsometric(cartPt);
                    if(tileType == 1) {
                        gameScene.renderXY(floorSprite, isoPt.x+borderOffset.x, isoPt.y + borderOffset.y - wallHeight, false);
                    } else {
                        gameScene.renderXY(wallSprite,  isoPt.x+borderOffset.x, isoPt.y + borderOffset.y, false);
                    }
                }
                
                function cartesianToIsometric(cartPt){
                    var tempPt=new Phaser.Point();
                    tempPt.x=cartPt.x-cartPt.y;
                    tempPt.y=(cartPt.x+cartPt.y)/2;
                    return (tempPt);
                }
                function isometricToCartesian(isoPt){
                    var tempPt=new Phaser.Point();
                    tempPt.x=(2*isoPt.y+isoPt.x)/2;
                    tempPt.y=(2*isoPt.y-isoPt.x)/2;
                    return (tempPt);
                }
                
                var bootState = {
                    create: function() {
                        game.state.start('load');
                    }
                };
                var loadState = {
                    preload: function() {
                        game.load.image('logo', 'images/phaser.png');
                        game.load.image('tile1', 'tiles/000.png');
                        game.load.image('tile2', 'tiles/001.png');
                    },
                    create: function() {
                        game.state.start('title');
                    }
                };
                var titleState = {
                    create: function() {
                        
                        //~ var logo = game.add.sprite(game.world.centerX, game.world.centerY, 'logo');
                        //~ logo.anchor.setTo(0.5, 0.5);
                        
                        game.stage.backgroundColor = '#cccccc';
                        console.log("Initialising gameScene");
                        gameScene = game.add.renderTexture(game.width,game.height);
                        game.add.sprite(0,0,gameScene);
                        floorSprite = game.make.sprite(0,0,'tile1');
                        wallSprite = game.make.sprite(0,0,'tile2');
                        
                        createLevel();
                        
                        var nameLabel = game.add.text(160,80, "Cliquer n'importe où pour démarrer", {
                            font: '14px Space Mone', fill: '#ffffff'
                        });
                        game.input.activePointer.capture = true;
                    },
                    update: function() {
                        if( game.input.activePointer.isDown ) {
                            //~ game.state.start('play');
                        }
                    }
                };
                
                //  Note that this html file is set to pull down Phaser 2.5.0 from the JS Delivr CDN.
                //  Although it will work fine with this tutorial, it's almost certainly not the most current version.
                //  Be sure to replace it with an updated version before you start experimenting with adding your own code.
                //~ var game = new Phaser.Game(480, 360, Phaser.AUTO, '', { preload: preload, create: create }, 'jeu');
                var game = new Phaser.Game(480, 360, Phaser.AUTO, 'gameDiv');
                
                game.state.add('boot', bootState);
                game.state.add('load', loadState);
                game.state.add('title', titleState);
                
                game.state.start('boot');

            };
        </script>
    </body>
</html>
